{% extends 'base.html' %}
{% block title %}Apólices Vencendo{% endblock %}
{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1><i class="fas fa-clock"></i> Apólices Vencendo</h1>
        <p class="page-subtitle">Apólices que vencem nos próximos 30 dias e precisam de atenção</p>
    </div>
    <div class="page-actions">
        <a href="{{ url_for('renovacoes') }}" class="btn btn-info">
            <i class="fas fa-sync-alt"></i> Ver Renovações
        </a>
        <a href="{{ url_for('apolices') }}" class="btn btn-secondary">
            <i class="fas fa-file-alt"></i> Todas as Apólices
        </a>
    </div>
</div>

<div class="stats-grid">
    <div class="stats-card urgent">
        <div class="stats-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stats-content">
            <h3>{{ apolices|selectattr('dias_vencimento')|select('<=', 7)|list|length }}</h3>
            <p>Vencem em 7 dias</p>
        </div>
    </div>
    
    <div class="stats-card warning">
        <div class="stats-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stats-content">
            <h3>{{ apolices|selectattr('dias_vencimento')|select('<=', 15)|list|length }}</h3>
            <p>Vencem em 15 dias</p>
        </div>
    </div>
    
    <div class="stats-card info">
        <div class="stats-icon">
            <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="stats-content">
            <h3>{{ apolices|length }}</h3>
            <p>Total Vencendo (30 dias)</p>
        </div>
    </div>
    
    <div class="stats-card success">
        <div class="stats-icon">
            <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stats-content">
            <h3>{{ "R$ {:,.2f}".format(apolices|sum(attribute='valor_premio') if apolices else 0) }}</h3>
            <p>Valor Total em Risco</p>
        </div>
    </div>
</div>

<div class="table-container">
    {% if apolices %}
    <div class="table-header">
        <h3><i class="fas fa-list"></i> Lista de Apólices Vencendo</h3>
        <div class="table-actions">
            <input type="text" id="search-input" placeholder="Buscar apólices..." class="search-input">
            <select id="urgency-filter" class="filter-select">
                <option value="">Todos os períodos</option>
                <option value="7">Vencem em 7 dias</option>
                <option value="15">Vencem em 15 dias</option>
                <option value="30">Vencem em 30 dias</option>
            </select>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Urgência</th>
                    <th>Apólice</th>
                    <th>Cliente</th>
                    <th>Seguradora</th>
                    <th>Tipo Seguro</th>
                    <th>Colaborador</th>
                    <th>Vencimento</th>
                    <th>Valor</th>
                    <th>Comissões</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for apolice in apolices %}
                <tr class="table-row" data-dias="{{ apolice.dias_vencimento }}">
                    <td>
                        {% if apolice.dias_vencimento <= 7 %}
                        <span class="urgency-badge critical">
                            <i class="fas fa-exclamation-triangle"></i>
                            {{ apolice.dias_vencimento }} dias
                        </span>
                        {% elif apolice.dias_vencimento <= 15 %}
                        <span class="urgency-badge high">
                            <i class="fas fa-clock"></i>
                            {{ apolice.dias_vencimento }} dias
                        </span>
                        {% else %}
                        <span class="urgency-badge medium">
                            <i class="fas fa-calendar"></i>
                            {{ apolice.dias_vencimento }} dias
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="policy-info">
                            <strong>{{ apolice.numero_apolice }}</strong>
                            <small>ID: {{ apolice.id_apolice }}</small>
                        </div>
                    </td>
                    <td>
                        <div class="client-info">
                            <strong>{{ apolice.cliente_nome }}</strong>
                        </div>
                    </td>
                    <td>{{ apolice.nome_seguradora }}</td>
                    <td>
                        <span class="type-badge">{{ apolice.nome_tipo_seguro }}</span>
                    </td>
                    <td>{{ apolice.nome_colaborador }}</td>
                    <td>
                        <div class="date-info">
                            <strong>{{ apolice.data_fim_vigencia.strftime('%d/%m/%Y') }}</strong>
                            <small>{{ apolice.data_inicio_vigencia.strftime('%d/%m/%Y') }} - {{ apolice.data_fim_vigencia.strftime('%d/%m/%Y') }}</small>
                        </div>
                    </td>
                    <td class="text-right">
                        <span class="currency">R$ {{ "{:,.2f}".format(apolice.valor_premio) }}</span>
                    </td>
                    <td class="text-center">
                        {% set comissao_corretora = apolice.valor_premio * (apolice.percentual_comissao_seguradora / 100) %}
                        {% set comissao_colaborador = apolice.valor_premio * (apolice.percentual_comissao_colaborador / 100) %}
                        <div class="commission-info">
                            <small>Corretora: R$ {{ "{:,.2f}".format(comissao_corretora) }}</small>
                            <small>Colaborador: R$ {{ "{:,.2f}".format(comissao_colaborador) }}</small>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="{{ url_for('nova_renovacao', id_apolice=apolice.id_apolice) }}" 
                               class="btn btn-sm btn-success" 
                               title="Renovar Apólice">
                                <i class="fas fa-sync-alt"></i>
                            </a>
                            <a href="{{ url_for('editar_apolice', id=apolice.id_apolice) }}" 
                               class="btn btn-sm btn-primary" 
                               title="Editar Apólice">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-info" 
                                    onclick="showContactInfo('{{ apolice.cliente_nome }}', '{{ apolice.nome_colaborador }}')"
                                    title="Informações de Contato">
                                <i class="fas fa-phone"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h3>Nenhuma apólice vencendo</h3>
        <p>Não há apólices vencendo nos próximos 30 dias. Excelente!</p>
        <a href="{{ url_for('apolices') }}" class="btn btn-primary">
            <i class="fas fa-file-alt"></i> Ver Todas as Apólices
        </a>
    </div>
    {% endif %}
</div>

<!-- Modal de Informações de Contato -->
<div id="contactModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h4><i class="fas fa-phone"></i> Informações de Contato</h4>
            <button class="close-modal" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="contactInfo"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Fechar</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sistema de busca
    const searchInput = document.getElementById('search-input');
    const urgencyFilter = document.getElementById('urgency-filter');
    const tableRows = document.querySelectorAll('.table-row');
    
    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const urgencyLimit = urgencyFilter.value ? parseInt(urgencyFilter.value) : null;
        
        tableRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const dias = parseInt(row.dataset.dias);
            
            const matchesSearch = text.includes(searchTerm);
            const matchesUrgency = !urgencyLimit || dias <= urgencyLimit;
            
            if (matchesSearch && matchesUrgency) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    searchInput.addEventListener('input', filterTable);
    urgencyFilter.addEventListener('change', filterTable);
});

function showContactInfo(cliente, colaborador) {
    document.getElementById('contactInfo').innerHTML = `
        <div class="contact-item">
            <strong>Cliente:</strong> ${cliente}
        </div>
        <div class="contact-item">
            <strong>Colaborador Responsável:</strong> ${colaborador}
        </div>
        <div class="contact-item">
            <small class="text-muted">Entre em contato para discutir a renovação</small>
        </div>
    `;
    document.getElementById('contactModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('contactModal').style.display = 'none';
}

// Fechar modal clicando fora
window.onclick = function(event) {
    const modal = document.getElementById('contactModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}
</script>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stats-card {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.stats-card.urgent .stats-icon {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.stats-card.warning .stats-icon {
    background: linear-gradient(135deg, #f39c12, #e67e22);
}

.stats-card.info .stats-icon {
    background: linear-gradient(135deg, #3498db, #2980b9);
}

.stats-card.success .stats-icon {
    background: linear-gradient(135deg, #27ae60, #229954);
}

.stats-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
}

.stats-content h3 {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
    color: #2c3e50;
}

.stats-content p {
    margin: 5px 0 0 0;
    color: #7f8c8d;
    font-size: 14px;
}

.urgency-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px;
    width: fit-content;
}

.urgency-badge.critical {
    background: #f8d7da;
    color: #721c24;
    animation: pulse 2s infinite;
}

.urgency-badge.high {
    background: #fff3cd;
    color: #856404;
}

.urgency-badge.medium {
    background: #d1ecf1;
    color: #0c5460;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.policy-info, .client-info, .date-info {
    display: flex;
    flex-direction: column;
}

.policy-info strong, .client-info strong, .date-info strong {
    color: #2c3e50;
    margin-bottom: 2px;
}

.policy-info small, .client-info small, .date-info small {
    color: #7f8c8d;
    font-size: 12px;
}

.type-badge {
    background: #9b59b6;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.commission-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.commission-info small {
    font-size: 11px;
    color: #6c757d;
}

.action-buttons {
    display: flex;
    gap: 5px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.currency {
    font-weight: 600;
    color: #27ae60;
}

.text-right {
    text-align: right;
}

.text-center {
    text-align: center;
}

.filter-select {
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    margin-left: 10px;
}

/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fff;
    margin: 15% auto;
    padding: 0;
    border-radius: 8px;
    width: 400px;
    max-width: 90%;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h4 {
    margin: 0;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-modal {
    background: none;
    border: none;
    font-size: 24px;
    color: #999;
    cursor: pointer;
}

.close-modal:hover {
    color: #333;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #ddd;
    text-align: right;
}

.contact-item {
    margin-bottom: 10px;
}

.contact-item:last-child {
    margin-bottom: 0;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .data-table {
        min-width: 900px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
}
</style>
{% endblock %}